@typeparam TItem
@using Template.Shared.Dto
@using Template.Web.Application.Services
@inject IHttpService HttpService

@if (IsFloating)
{
    <div class="form-floating suggest-select-container @(Class)">
        <input type="text" 
               class="form-control" 
               id="@Id"
               placeholder=" "
               value="@_currentTextValue" 
               @oninput="OnTextInput" 
               @onfocus="ShowSuggestions"
               @onblur="HideSuggestionsDelayed"
               disabled="@Disabled" />
        <label for="@Id">@Placeholder</label>
        
        @if (_showSuggestions)
        {
            <div class="suggestion-dropdown floating">
                @RenderSuggestionContent
            </div>
        }
    </div>
}
else
{
    <div class="suggest-select-container @(Class)">
        <input type="text" 
               class="form-control" 
               placeholder="@Placeholder" 
               value="@_currentTextValue" 
               @oninput="OnTextInput" 
               @onfocus="ShowSuggestions"
               @onblur="HideSuggestionsDelayed"
               disabled="@Disabled" />
        
        @if (_showSuggestions)
        {
            <div class="suggestion-dropdown">
                @RenderSuggestionContent
            </div>
        }
    </div>
}

<style>
    .suggest-select-container {
        position: relative;
    }
    
    .form-floating .floating-input-wrapper {
        position: relative;
    }
    
    .suggestion-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1050;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 2px;
    }
    
    .suggestion-dropdown.floating {
        top: 100%;
    }
    
    .suggestion-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .suggestion-item.disabled {
        color: #6c757d;
        pointer-events: none;
        opacity: 0.65;
    }
</style>

@code {
    [Parameter]
    public string Value { get; set; } = "";
    
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter] 
    public string Class { get; set; } = "";

    [Parameter]
    public string Placeholder { get; set; } = "Vyberte alebo zadajte...";
    
    [Parameter]
    public IEnumerable<TItem> Options { get; set; } = new List<TItem>();
    
    [Parameter]
    public Func<TItem, string> StringSelector { get; set; } = item => item?.ToString() ?? string.Empty;
    
    [Parameter]
    public bool CanFilter { get; set; } = true;
    
    [Parameter]
    public bool Disabled { get; set; }
    
    [Parameter]
    public RenderFragment<TItem>? Option { get; set; }
    
    [Parameter]
    public bool IsPaginated { get; set; }
    
    [Parameter]
    public string ApiUrl { get; set; } = string.Empty;
    
    [Parameter]
    public string AdditionalParams { get; set; } = string.Empty;
    
    [Parameter]
    public bool AutoShowSuggestions { get; set; }
    
    [Parameter]
    public bool IsFloating { get; set; }
    
    private string Id { get; } = $"suggest-select-{Guid.NewGuid():N}";
    private string _currentTextValue = "";
    private bool _showSuggestions;
    private bool _isLoading;
    private List<TItem> _options = new();
    private List<TItem> _filteredOptions = new();
    private Timer? _hideTimer;
    
    protected override async Task OnInitializedAsync()
    {
        _currentTextValue = Value;
        _options = Options.ToList();
        _filteredOptions = _options.ToList();
        
        if (IsPaginated && !string.IsNullOrEmpty(ApiUrl))
        {
            await LoadOptionsFromApi();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (AutoShowSuggestions)
            {
                // Wait a bit before showing suggestions to ensure the UI is fully rendered
                await Task.Delay(100);
                await InvokeAsync(() => {
                    ShowSuggestions();
                    StateHasChanged();
                });
            }
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }
    
    protected override void OnParametersSet()
    {
        _currentTextValue = Value;
        
        if (!IsPaginated)
        {
            _options = Options.ToList();
            ApplyFilter();
        }
    }
    
    private RenderFragment RenderSuggestionContent => __builder =>
    {
        if (_isLoading && (_options.Count == 0))
        {
            <div class="suggestion-item">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            foreach (var option in _filteredOptions)
            {
                <div class="suggestion-item @(Disabled ? "disabled" : "")" @onclick="() => SelectOption(option)">
                    @if (Option != null)
                    {
                        @Option(option)
                    }
                    else
                    {
                        @StringSelector(option)
                    }
                </div>
            }
        }
        
        if (_isLoading && (_options.Count > 0))
        {
            <div class="suggestion-item">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        }
    };
    
    private async Task LoadOptionsFromApi()
    {
        if (!IsPaginated || string.IsNullOrEmpty(ApiUrl))
            return;
            
        _isLoading = true;
        StateHasChanged();
        
        try
        {
            var queryParams = $"page=1&pageSize=100&query={_currentTextValue}&{AdditionalParams}";
            var response = await HttpService.Get<PaginatedListDto<TItem>>($"{ApiUrl}?{queryParams}");
            
            if (response != null)
            {
                _options = response.Items.ToList();
                _filteredOptions = _options.ToList();
            }
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error loading options from API: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task OnTextInput(ChangeEventArgs e)
    {
        _currentTextValue = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(_currentTextValue);
        
        // Show suggestions as user types
        ShowSuggestions();
        
        // Filter options based on text input
        if (IsPaginated)
        {
            await LoadOptionsFromApi();
        }
        else
        {
            ApplyFilter();
        }
    }
    
    private void ShowSuggestions()
    {
        _hideTimer?.Dispose();
        _showSuggestions = true;
    }
    
    private void HideSuggestionsDelayed()
    {
        // Use timer to delay hiding to allow click to register
        _hideTimer?.Dispose();
        _hideTimer = new Timer(_ => 
        {
            InvokeAsync(() => 
            {
                _showSuggestions = false;
                StateHasChanged();
            });
        }, null, 200, Timeout.Infinite);
    }
    
    private async Task SelectOption(TItem option)
    {
        _currentTextValue = StringSelector(option);
        await ValueChanged.InvokeAsync(_currentTextValue);
        _showSuggestions = false;
    }
    
    private void ApplyFilter()
    {
        if (string.IsNullOrEmpty(_currentTextValue))
        {
            _filteredOptions = _options.ToList();
        }
        else
        {
            _filteredOptions = _options
                .Where(opt => StringSelector(opt)
                    .Contains(_currentTextValue, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }
}
